<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0e0f1a" />
  <title>Happy 20th Birthday ‚Äì HeartQuest</title>
  <meta name="description" content="A playful single-file birthday website with a tiny arcade game that unlocks a personalized congratulations & present." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0e0f1a; --bg2:#15172b; --card:#1d203a; --text:#f8f9ff; --muted:#c9cbe8;
      --brand:#ff6ec7; --brand2:#7cf7ff; --win:#21d07a; --lose:#ff4d6d; --gold:#ffd166;
      --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    *, *::before, *::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 10%, #1e2144 0%, transparent 60%),
        radial-gradient(800px 400px at 90% 0%, #0f2b3a 0%, transparent 60%),
        linear-gradient(180deg, #0e0f1a 0%, #0a0b12 100%);
      overflow-x:hidden; -webkit-tap-highlight-color: transparent; user-select:none;
    }

    /* Utility */
    .hidden{display:none}
    .btn{appearance:none; border:none; cursor:pointer; padding:14px 20px; border-radius:16px; font-weight:700; letter-spacing:.3px;
      background:linear-gradient(135deg, var(--brand), var(--brand2)); color:#0b0b12; box-shadow:var(--shadow); transition:transform .08s ease, filter .2s ease}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.secondary{background:linear-gradient(135deg, #8b9ad8, #b7c2ff); color:#101327}
    .btn.ghost{background:transparent; border:2px solid #3a3d66; color:var(--text)}
    .btn.full{width:100%}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08);
      border-radius:24px; box-shadow:var(--shadow); backdrop-filter: blur(10px)}

    .container{max-width:1100px; margin:0 auto; padding:clamp(12px, 3vw, 24px)}
    .center{display:flex; align-items:center; justify-content:center}
    .stack{display:flex; flex-direction:column; gap:18px}
    .row{display:flex; gap:14px; flex-wrap:wrap}

    header.hero{padding:40px 20px 10px; text-align:center}
    header.hero h1{font-size:clamp(28px, 6vw, 56px); margin:8px 0 0; line-height:1.05}
    header.hero p{color:var(--muted)}

    /* Screens */
    .screen{min-height:100dvh; padding:20px; position:relative; padding-bottom:calc(20px + env(safe-area-inset-bottom))}

    /* Floating stars background */
    .stars{position:absolute; inset:0; overflow:hidden; pointer-events:none}

    /* Start Screen */
    #screen-start .card{max-width:760px; margin:0 auto; padding:clamp(16px, 2.5vw, 28px)}
    #screen-start h2{font-size:clamp(20px, 4vw, 34px); margin:0}

    .input{display:flex; gap:10px; align-items:center; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      border-radius:14px; padding:10px 12px; flex:1; min-width:min(100%, 280px)}
    .input input, .input select{flex:1; background:transparent; border:0; outline:none; color:var(--text); font-size:16px}

    /* Game Screen */
    #screen-game .hud{position:sticky; top:0; margin:0 auto; display:flex; gap:10px; align-items:center; z-index:5; padding:10px; justify-content:center}
    @supports (backdrop-filter: blur(6px)){
      #screen-game .hud{backdrop-filter: blur(6px)}
    }
    .pill{padding:8px 12px; border-radius:999px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); font-weight:600}

    /* ‚úÖ Responsive canvas: never wider than parent, safe height on phones */
    #gameCanvas{
      width:min(100%, 1100px);
      height:clamp(320px, 70vh, 600px);
      border-radius:24px; display:block; margin:12px auto 12px;
      background:radial-gradient(1200px 400px at 50% -10%, rgba(255,255,255,.12), transparent 60%),
                 linear-gradient(180deg, #0f1427, #0a0e1d);
      touch-action:none
    }

    .controls{display:flex; justify-content:center; gap:10px; margin:8px 0 24px}
    .kbd{background:#0b0d18; border:1px solid #2a2d52; color:#cbd0ff; padding:6px 10px; border-radius:10px; font-weight:700}

    .progress{height:10px; width:260px; border-radius:999px; background:#25284a; overflow:hidden}
    .progress > div{height:100%; width:0%; background:linear-gradient(90deg, var(--brand), var(--brand2)); transition:width .2s ease}

    /* Prize Screen */
    #screen-prize .card{max-width:900px; margin:0 auto; padding:clamp(16px, 2.5vw, 28px)}
    .gift{position:relative; width:min(420px, 80vw); aspect-ratio:1; margin:10px auto 20px}
    .gift .box{position:absolute; inset:14% 10% 10% 10%; background:linear-gradient(180deg, #ff6ec7, #c34ba0); border-radius:20px; box-shadow:var(--shadow)}
    .gift .ribbon-h{position:absolute; left:50%; top:10%; bottom:10%; width:12%; background:#ffd166; transform:translateX(-50%); border-radius:8px}
    .gift .lid{position:absolute; left:6%; right:6%; top:0; height:24%; background:linear-gradient(180deg, #ff89d3, #e364ba); border-radius:18px; transform-origin:bottom; transition:transform .6s ease}
    .gift.open .lid{transform:rotateX(140deg) translateZ(0)}
    .gift .ribbon-v{position:absolute; top:0; left:0; right:0; height:12%; background:#ffd166; border-radius:18px}
    .glow{position:absolute; inset:-10% -10% -10% -10%; background:radial-gradient(circle at 50% 30%, rgba(255,209,102,.25), transparent 55%); filter: blur(10px); opacity:0; transition:opacity .5s ease}
    .gift.open .glow{opacity:1}

    .message{font-size:clamp(16px, 2.6vw, 20px); color:var(--muted)}

    /* Mobile joystick: only show on touch devices */
    #joystick{position:fixed; bottom:calc(22px + env(safe-area-inset-bottom)); left:22px; width:120px; height:120px; border-radius:50%; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.16); display:none; z-index:9; touch-action:none}
    #joystick .nub{position:absolute; left:50%; top:50%; width:56px; height:56px; border-radius:50%; background:#2a2f5e; transform:translate(-50%,-50%)}
    @media (hover:none) and (pointer:coarse){ #joystick{display:block} }

    /* Stack form & buttons on small screens */
    @media (max-width: 740px){
      .row{flex-direction:column}
      .btn{padding:16px 18px}
      #screen-game .hud{flex-wrap:wrap; gap:8px}
      .progress{width:min(75vw, 320px)}
      .controls .pill{max-width:92vw; text-align:center}
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce){ .btn, .gift .lid{transition:none} }
  </style>
</head>
<body>
  <canvas id="confetti" class="hidden"></canvas>

  <!-- START SCREEN -->
  <section id="screen-start" class="screen">
    <div class="stars" aria-hidden="true"></div>
    <header class="hero">
      <div class="container">
        <p class="pill" style="display:inline-block">Level up love: 20 üéÇ</p>
        <h1>Happy 20th Birthday, <span id="youName">You</span>! üíñ</h1>
        <p>Play a tiny game to unlock your surprise for <strong id="gfPreview">your love</strong> ‚ú®</p>
      </div>
    </header>

    <div class="container">
      <div class="card">
        <div class="stack">
          <h2>HeartQuest: catch the hearts, win the present</h2>
          <div class="row">
            <label class="input" style="flex:2">
              <span style="opacity:.8">Your name</span>
              <input id="yourName" aria-label="Your name" placeholder="e.g., Yoas" maxlength="18" />
            </label>
            <label class="input" style="flex:2">
              <span style="opacity:.8">Girlfriend's name</span>
              <input id="gfName" aria-label="Girlfriend's name" placeholder="e.g., Sarah" maxlength="24" />
            </label>
          </div>
          <div class="row">
            <label class="input" style="flex:1">
              <span style="opacity:.8">Difficulty</span>
              <select id="difficulty" aria-label="Difficulty">
                <option value="easy">Easy ‚Äì comfy vibe</option>
                <option value="normal" selected>Normal ‚Äì fun challenge</option>
                <option value="hard">Hard ‚Äì show off üòé</option>
              </select>
            </label>
            <label class="input" style="flex:1">
              <span style="opacity:.8">Goal (hearts)</span>
              <input id="goal" type="number" min="6" max="35" value="12" />
            </label>
            <label class="input" style="flex:1">
              <span style="opacity:.8">Timer (seconds)</span>
              <input id="seconds" type="number" min="15" max="120" value="45" />
            </label>
          </div>

          <div class="row" style="align-items:center">
            <button id="btnStart" class="btn full">Start the Game üíò</button>
            <button id="btnPreviewPrize" class="btn ghost full">Peek the Gift ‚ú®</button>
          </div>

          <div class="stack" style="margin-top:8px">
            <div class="pill">Controls: <span class="kbd">‚Üê</span> <span class="kbd">‚Üí</span> <span class="kbd">‚Üë</span> <span class="kbd">‚Üì</span> or drag the joystick (mobile)</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GAME SCREEN -->
  <section id="screen-game" class="screen hidden" aria-live="polite">
    <div class="hud">
      <div class="pill">Hearts: <span id="score">0</span>/<span id="goalHUD">12</span></div>
      <div class="pill">Time: <span id="time">45</span>s</div>
      <div class="progress" title="Progress"><div id="progressBar"></div></div>
      <button id="btnPause" class="btn secondary" style="padding:8px 14px">Pause</button>
      <button id="btnQuit" class="btn ghost" style="padding:8px 14px">Quit</button>
    </div>

    <canvas id="gameCanvas" width="1100" height="600" aria-label="HeartQuest game area"></canvas>
    <div class="controls">
      <span class="pill">Catch glowing hearts, avoid meteors!</span>
    </div>
    <div id="joystick" role="application" aria-label="Virtual joystick"><div class="nub"></div></div>
  </section>

  <!-- PRIZE SCREEN -->
  <section id="screen-prize" class="screen hidden">
    <header class="hero">
      <div class="container">
        <h1 id="ggCongrats">Congratulations! üéâ</h1>
        <p class="message">You did it, <span id="playerNameOut">Champion</span>! You unlocked <strong id="gfOut">her</strong> birthday surprise.</p>
      </div>
    </header>

    <div class="container">
      <div class="card">
        <div class="stack">
          <div class="gift" id="giftBox" aria-live="polite">
            <div class="glow"></div>
            <div class="box"></div>
            <div class="ribbon-h"></div>
            <div class="ribbon-v"></div>
            <div class="lid"></div>
          </div>

          <div class="row">
            <button id="btnOpenGift" class="btn full">Open the Present üéÅ</button>
          </div>

          <article class="card hidden" id="letter" style="padding:20px">
            <h2 style="margin-top:6px">For <span id="gfLetter">You</span> üíå</h2>
            <p class="message" id="letterBody" style="white-space:pre-line; line-height:1.6"></p>
            <div class="row" style="margin-top:8px">
              <button id="btnPlayAgain" class="btn secondary">Play Again</button>
              <button id="btnDownload" class="btn ghost">Save this message</button>
            </div>
          </article>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Simple star field background
    (function stars(){
      const layers = document.querySelectorAll('.stars');
      layers.forEach(layer=>{
        for(let i=0;i<80;i++){
          const s = document.createElement('span');
          const size = Math.random()*2+1;
          Object.assign(s.style,{
            position:'absolute', width:size+'px', height:size+'px', borderRadius:'50%',
            left: Math.random()*100+'%', top: Math.random()*100+'%',
            background: i%9===0? 'var(--brand2)': 'rgba(255,255,255,.7)',
            opacity: Math.random()*0.8+0.2,
            boxShadow: '0 0 6px rgba(255,255,255,.5)'
          });
          layer.appendChild(s)
        }
      });
    })();

    // SPA helpers
    const show = id => {
      document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    };

    // Form & personalization
    const yourName = document.getElementById('yourName');
    const gfName = document.getElementById('gfName');
    const youNameSpan = document.getElementById('youName');
    const gfPreview = document.getElementById('gfPreview');

    [yourName, gfName].forEach(inp=>{
      inp.addEventListener('input', ()=>{
        youNameSpan.textContent = yourName.value || 'You';
        gfPreview.textContent = gfName.value? gfName.value+"'s surprise" : 'your love';
      });
    });

    // ===== GAME IMPLEMENTATION =====
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const goalHUD = document.getElementById('goalHUD');
    const timeEl = document.getElementById('time');
    const progressBar = document.getElementById('progressBar');
    const joystick = document.getElementById('joystick');
    const nub = joystick.querySelector('.nub');

    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnQuit = document.getElementById('btnQuit');
    const btnPreviewPrize = document.getElementById('btnPreviewPrize');
    const btnPlayAgain = document.getElementById('btnPlayAgain');

    const difficulty = document.getElementById('difficulty');
    const goalInput = document.getElementById('goal');
    const secondsInput = document.getElementById('seconds');

    let state = 'idle'; // idle | playing | paused | ended
    let goal = 12, timeLeft = 45, score = 0;

    // Logical canvas size (CSS pixels) ‚Äì used for ALL game math/rendering
    let CW = 1100, CH = 600;

    const rnd = (min,max)=> Math.random()*(max-min)+min;

    const player = {x: CW/2, y: CH-70, r: 18, speed: 4.2, vx:0, vy:0};
    let hearts = []; // falling collectibles
    let meteors = []; // hazards
    let lastSpawn = 0, lastMeteor = 0;

    function configureDifficulty(){
      const d = difficulty.value;
      if(d==='easy'){ player.speed=4.6; spawnRate=600; meteorRate=1500; heartFall=2.2; meteorFall=3.2 }
      else if(d==='hard'){ player.speed=5.2; spawnRate=380; meteorRate=900; heartFall=2.8; meteorFall=4.2 }
      else { player.speed=4.2; spawnRate=480; meteorRate=1200; heartFall=2.5; meteorFall=3.6 }
    }

    let spawnRate=480, meteorRate=1200, heartFall=2.5, meteorFall=3.6;

    function resetGame(){
      configureDifficulty();
      goal = Math.max(6, Math.min(35, parseInt(goalInput.value||12)));
      timeLeft = Math.max(15, Math.min(120, parseInt(secondsInput.value||45)));
      score = 0; scoreEl.textContent=score; goalHUD.textContent=goal; timeEl.textContent=timeLeft;
      progressBar.style.width = '0%';
      player.x = CW/2; player.y = CH-70; player.vx=0; player.vy=0;
      hearts.length=0; meteors.length=0; lastSpawn=0; lastMeteor=0;
    }

    // Keyboard control
    const keys = new Set();
    window.addEventListener('keydown', e=>{ if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown',' '].includes(e.key)){ e.preventDefault(); keys.add(e.key) } });
    window.addEventListener('keyup', e=> keys.delete(e.key));

    // Virtual joystick
    let joyActive=false, joyStart={x:0,y:0};
    const joyBounds = 46; // max radius
    function joyPos(clientX, clientY){
      const rect = joystick.getBoundingClientRect();
      return {x: clientX-rect.left-rect.width/2, y: clientY-rect.top-rect.height/2};
    }
    function onJoyStart(e){
      e.preventDefault();
      joyActive=true; const p = e.touches? e.touches[0]: e; const pos = joyPos(p.clientX,p.clientY); joyStart = pos; moveNub(pos.x,pos.y)
    }
    function onJoyMove(e){ if(!joyActive) return; e.preventDefault(); const p = e.touches? e.touches[0]: e; const pos = joyPos(p.clientX,p.clientY); moveNub(pos.x,pos.y) }
    function onJoyEnd(){ joyActive=false; moveNub(0,0) }
    function moveNub(x,y){
      const len = Math.hypot(x,y); const clamped = Math.min(len, joyBounds);
      const nx = len? x/len*clamped:0, ny = len? y/len*clamped:0;
      nub.style.transform = `translate(calc(-50% + ${nx}px), calc(-50% + ${ny}px))`;
      // map to velocities
      player.vx = (nx/joyBounds)*player.speed*1.1;
      player.vy = (ny/joyBounds)*player.speed*1.1;
    }
    ['pointerdown','pointermove','pointerup','pointercancel'].forEach(type=>joystick.addEventListener(type, e=>{
      if(type==='pointerdown') onJoyStart(e);
      else if(type==='pointermove') onJoyMove(e);
      else onJoyEnd(e);
    }, {passive:false}));
    joystick.addEventListener('touchstart', onJoyStart, {passive:false});
    joystick.addEventListener('touchmove', onJoyMove, {passive:false});
    joystick.addEventListener('touchend', onJoyEnd);

    // Game loop
    let rafId; let lastTime=0; let timerTick=0;
    function loop(ts){
      if(state!=='playing'){ return }
      rafId = requestAnimationFrame(loop);
      const dt = Math.min(32, ts - (lastTime||ts)); lastTime = ts; timerTick += dt;

      // Timer
      if(timerTick>=1000){
        timerTick = 0; timeLeft--; timeEl.textContent=timeLeft; if(timeLeft<=0){ endGame(false) }
      }

      // Input -> velocity
      const accel = 0.9;
      let vx=0, vy=0;
      if(keys.has('ArrowLeft')) vx -= player.speed;
      if(keys.has('ArrowRight')) vx += player.speed;
      if(keys.has('ArrowUp')) vy -= player.speed;
      if(keys.has('ArrowDown')) vy += player.speed;
      // blend with joystick (already setting player.vx/vy)
      if(vx||vy){ player.vx=vx; player.vy=vy }

      player.x += player.vx*accel; player.y += player.vy*accel;

      // ‚úÖ Clamp inside the visible field
      player.x = Math.max(player.r, Math.min(CW - player.r, player.x));
      player.y = Math.max(player.r, Math.min(CH - player.r, player.y));

      // Spawning
      if(ts - lastSpawn > spawnRate){
        lastSpawn = ts;
        hearts.push({x:rnd(30, CW-30), y:-20, r: 14+rnd(-2,4), vy: heartFall + rnd(-.4, .4)});
      }
      if(ts - lastMeteor > meteorRate){
        lastMeteor = ts;
        meteors.push({x:rnd(24, CW-24), y:-30, r: 12+rnd(0,6), vy: meteorFall + rnd(-.3,.5)});
      }

      // Physics + collisions
      for(const h of hearts){ h.y += h.vy }
      for(const m of meteors){ m.y += m.vy }
      hearts = hearts.filter(h=> h.y < CH + 40);
      meteors = meteors.filter(m=> m.y < CH + 40);

      for(let i=hearts.length-1;i>=0;i--){
        const h = hearts[i];
        if(Math.hypot(h.x-player.x, h.y-player.y) < h.r + player.r){
          hearts.splice(i,1); score++; scoreEl.textContent=score; progressBar.style.width = Math.min(100, (score/goal)*100) + '%';
          pulse(); if(score>=goal){ endGame(true); return }
        }
      }
      for(const m of meteors){
        if(Math.hypot(m.x-player.x, m.y-player.y) < m.r + player.r){
          // small penalty
          score = Math.max(0, score-1); scoreEl.textContent=score; pop();
          // knockback
          player.y = Math.min(CH-player.r, player.y+24)
        }
      }

      // Render
      ctx.clearRect(0,0,CW,CH);
      drawBackground();
      drawHearts();
      drawMeteors();
      drawPlayer();
    }

    function drawBackground(){
      const grd = ctx.createLinearGradient(0,0,0,CH);
      grd.addColorStop(0,'rgba(255,255,255,0.06)');
      grd.addColorStop(1,'rgba(255,255,255,0.00)');
      ctx.fillStyle = grd; ctx.fillRect(0,0,CW,CH);
      // lane lines
      ctx.strokeStyle = 'rgba(255,255,255,.06)'; ctx.lineWidth = 2; ctx.setLineDash([6,10]);
      for(let x=100; x<CW; x+=200){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,CH); ctx.stroke() }
      ctx.setLineDash([])
    }

    function heartPath(x,y,r){
      ctx.beginPath();
      const topCurveHeight = r * 0.3;
      ctx.moveTo(x, y + topCurveHeight);
      ctx.bezierCurveTo(x, y, x - r, y, x - r, y + topCurveHeight);
      ctx.bezierCurveTo(x - r, y + (r + topCurveHeight)/2, x, y + (r + topCurveHeight), x, y + r*1.4);
      ctx.bezierCurveTo(x, y + (r + topCurveHeight), x + r, y + (r + topCurveHeight)/2, x + r, y + topCurveHeight);
      ctx.bezierCurveTo(x + r, y, x, y, x, y + topCurveHeight);
      ctx.closePath();
    }

    function drawHearts(){
      for(const h of hearts){
        heartPath(h.x, h.y, h.r);
        const g = ctx.createRadialGradient(h.x, h.y, 2, h.x, h.y, h.r*1.4);
        g.addColorStop(0,'rgba(255,110,199,.95)');
        g.addColorStop(1,'rgba(124,247,255,.2)');
        ctx.fillStyle = g; ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,.6)'; ctx.lineWidth = 1; ctx.stroke();
      }
    }

    function drawMeteors(){
      for(const m of meteors){
        ctx.beginPath(); ctx.arc(m.x, m.y, m.r, 0, Math.PI*2);
        const g = ctx.createRadialGradient(m.x, m.y, 2, m.x, m.y, m.r);
        g.addColorStop(0,'rgba(255,77,109,.9)'); g.addColorStop(1,'rgba(255,77,109,.2)');
        ctx.fillStyle = g; ctx.fill();
      }
    }

    function drawPlayer(){
      // body
      ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
      const g = ctx.createRadialGradient(player.x-3, player.y-3, 2, player.x, player.y, player.r);
      g.addColorStop(0,'rgba(124,247,255,1)'); g.addColorStop(1,'rgba(124,247,255,.15)');
      ctx.fillStyle = g; ctx.fill();
      // outline
      ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(255,255,255,.65)'; ctx.stroke();
      // face
      ctx.fillStyle = '#0b0d18';
      ctx.beginPath(); ctx.arc(player.x-5, player.y-2, 2, 0, Math.PI*2); ctx.arc(player.x+5, player.y-2, 2, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(player.x, player.y+4, 6, 0, Math.PI); ctx.strokeStyle='rgba(11,13,24,.9)'; ctx.stroke();
    }

    // Tiny feedback pulses
    function pulse(){
      progressBar.animate([{transform:'scaleX(1.02)'},{transform:'scaleX(1)'}], {duration:120, easing:'ease-out'});
      if(navigator.vibrate) navigator.vibrate(10);
    }
    function pop(){
      document.body.animate([{filter:'saturate(1.2)'},{filter:'saturate(1)'}],{duration:250, easing:'ease-out'});
      if(navigator.vibrate) navigator.vibrate(20);
    }

    // Confetti
    const confettiCanvas = document.getElementById('confetti');
    const cctx = confettiCanvas.getContext('2d');
    let confettiPieces = []; let confettiRAF;
    function startConfetti(){
      confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; confettiCanvas.classList.remove('hidden');
      confettiPieces = Array.from({length: 160}, ()=>({
        x: Math.random()*confettiCanvas.width,
        y: Math.random()*-confettiCanvas.height,
        r: Math.random()*6+2,
        vy: Math.random()*2+1,
        vx: Math.random()*1-0.5,
        rot: Math.random()*Math.PI,
      }));
      cancelAnimationFrame(confettiRAF);
      const draw = ()=>{
        confettiRAF = requestAnimationFrame(draw);
        cctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
        confettiPieces.forEach(p=>{
          p.y += p.vy; p.x += p.vx; p.rot += 0.05;
          if(p.y>confettiCanvas.height+20){ p.y = -10; p.x = Math.random()*confettiCanvas.width }
          cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.rot);
          cctx.fillStyle = Math.random()>0.5? '#ff6ec7':'#7cf7ff';
          cctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
          cctx.restore();
        });
      };
      draw();
      setTimeout(stopConfetti, 6000);
    }
    function stopConfetti(){
      cancelAnimationFrame(confettiRAF); confettiCanvas.classList.add('hidden');
    }

    function endGame(won){
      state='ended'; cancelAnimationFrame(rafId);
      if(won){
        startConfetti();
        // Transition to prize screen with personalization
        const pName = yourName.value || 'Sweetheart';
        const gName = gfName.value || 'My Love';
        document.getElementById('playerNameOut').textContent = pName;
        document.getElementById('gfOut').textContent = gName + "'s";
        document.getElementById('gfLetter').textContent = gName;
        document.getElementById('ggCongrats').textContent = `You caught ${score} hearts! Present unlocked üóùÔ∏è`;
        show('screen-prize');
      } else {
        alert('Time is up! Try again ‚Äî you got '+score+' hearts.');
        show('screen-start');
      }
    }

    function startGame(){
      resetGame();
      state='playing'; show('screen-game');
      lastTime=0; timerTick=0; rafId=requestAnimationFrame(loop);
    }

    // Buttons
    btnStart.addEventListener('click', startGame);
    btnQuit.addEventListener('click', ()=>{ state='idle'; cancelAnimationFrame(rafId); show('screen-start') });
    btnPause.addEventListener('click', ()=>{
      if(state==='playing'){ state='paused'; btnPause.textContent='Resume'; cancelAnimationFrame(rafId) }
      else if(state==='paused'){ state='playing'; btnPause.textContent='Pause'; lastTime=0; rafId=requestAnimationFrame(loop) }
    });
    btnPreviewPrize.addEventListener('click', ()=>{ show('screen-prize') });
    btnPlayAgain && btnPlayAgain.addEventListener('click', ()=>{ show('screen-start') });

    // Gift open + letter
    const btnOpenGift = document.getElementById('btnOpenGift');
    const giftBox = document.getElementById('giftBox');
    const letter = document.getElementById('letter');
    const letterBody = document.getElementById('letterBody');
    const btnDownload = document.getElementById('btnDownload');

    btnOpenGift.addEventListener('click', ()=>{
      giftBox.classList.add('open');
      // Build a sweet message
      const you = yourName.value || 'I';
      const her = gfName.value || 'you';
      const msg = `Happy 20th Birthday, ${her}!\n\n`+
        `${you} made this little game so that every heart you catch is a little promise: to laugh with you, `+
        `to support you, and to keep choosing you‚Äîtoday and every day.\n\n`+
        `May this year be full of cozy mornings, spontaneous adventures, and victories big and small. `+
        `You are loved more than words (and pixels) can show.\n\n`+
        `‚Äî With all my love, ${yourName.value||'your player 2'} üíñ`;
      letterBody.textContent = msg;
      letter.classList.remove('hidden');
      btnOpenGift.disabled = true; btnOpenGift.textContent = 'Present Opened ‚ú®';
    });

    btnDownload.addEventListener('click', ()=>{
      // Download the letter as a text file
      const blob = new Blob([letterBody.textContent], {type:'text/plain'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'birthday-letter.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // ‚úÖ Make canvas responsive & keep logic in CSS pixels
    function fitCanvas(){
      const w = Math.min(document.documentElement.clientWidth - 20, 1100);
      const h = Math.min(Math.max(window.innerHeight*0.6, 320), 600);
      CW = w; CH = h;

      const ratio = window.devicePixelRatio || 1;
      canvas.style.width  = w +'px';
      canvas.style.height = h +'px';
      canvas.width  = Math.floor(w * ratio);
      canvas.height = Math.floor(h * ratio);
      ctx.setTransform(ratio,0,0,ratio,0,0);
    }
    addEventListener('resize', fitCanvas); fitCanvas();

    // Accessibility: pause when tab hidden
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden && state==='playing'){ btnPause.click() }
    });

    // Prevent page scroll while dragging joystick
    document.addEventListener('touchmove', e=>{ if(joyActive) e.preventDefault() }, {passive:false});
  </script>
</body>
</html>
